extractRequestData:
  assign:
    chatId: ${incoming.body.chatId}
    filename: ${incoming.body.filename}
    filecontent: ${incoming.body.filecontent}

getUserInputByChatId:
  call: http.post
  args:
    url: https://byk-resql:8443/get-user-inputs
    body:
      chatId: ${chatId}
  result: getUserInputResult

fromatUserInput:
  call: http.post
  args:
    url: https://data_mapper:3005/json/v2/format_user_input
    body:
      input: ${getUserInputResult.response.body}
      template: ${filecontent}
  result: formatedUserInput

convertDataToPDF:
  call: http.get
  args:
    url: http://data_mapper:3005/js/convert/pdf
    body:
      data: ${formatedUserInput}
  result: pdfFile
  next: returnSuccess

checkPDFExists:
  switch:
    - condition: ${!!pdfFile.response.body && pdfFile.response.body !== null}
      next: returnSuccess
  next: returnFailure

returnSuccess:
  wrapper: false
  headers:
    Content-disposition: "attachment;filename=${filename}.pdf"
  return: ${pdfFile.response.body}
  next: end

returnFailure:
  status: 400
  return: "error: unable to download PDF"
  next: end

return_incorrect_request:
  status: 400
  return: 'missing parameters'
  next: end
